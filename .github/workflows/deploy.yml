name: Build and Deploy

on:
  push:
    branches: [master]
  workflow_dispatch:
  # Auto-merge í›„ ìë™ ë°°í¬
  pull_request:
    types: [closed]
    branches: [master]

permissions:
  contents: read
  pages: write
  id-token: write
  issues: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:run

      - name: Type check
        run: npm run type-check

      - name: Lint code
        run: npm run lint

      - name: Validate data
        run: |
          python scripts/validate-terms.py
          python scripts/check-duplicates.py
          python scripts/validate-sorting.py
          python scripts/validate-index.py

      - name: Build project
        run: npm run build:github

      - name: Generate dynamic sitemap
        run: |
          python .github/scripts/generate-sitemap.py > dist/sitemap.xml

      - name: Generate robots.txt
        run: |
          echo 'User-agent: *' > dist/robots.txt
          echo 'Allow: /' >> dist/robots.txt
          echo '' >> dist/robots.txt
          echo 'Sitemap: https://glossary.kr/sitemap.xml' >> dist/robots.txt

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-deployment:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    
    steps:
      - name: Notify successful deployment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const deploymentUrl = '${{ needs.deploy.outputs.page_url }}';
            
            // ê´€ë ¨ ì´ìŠˆ ì°¾ê¸° (PR ì œëª©ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ)
            const prTitle = '${{ github.event.pull_request.title }}';
            const issueMatch = prTitle.match(/#(\d+)/);
            
            const deploymentComment = "## ğŸš€ ë°°í¬ ì™„ë£Œ\n\n" +
              "PRì´ ì„±ê³µì ìœ¼ë¡œ ë³‘í•©ë˜ê³  ì‚¬ì´íŠ¸ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
              "### ğŸŒ ì‚¬ì´íŠ¸ ì •ë³´\n" +
              "- **ë©”ì¸ ì‚¬ì´íŠ¸**: [https://glossary.kr](https://glossary.kr)\n" +
              `- **ë°°í¬ ì‹œê°„**: ${new Date().toISOString().replace('T', ' ').substring(0, 19)} UTC\n` +
              "- **ìƒíƒœ**: âœ… ë°°í¬ ì™„ë£Œ\n\n" +
              "### ğŸ“Š ë³€ê²½ì‚¬í•­\n" +
              "- ìƒˆë¡œìš´ ìš©ì–´ê°€ ë©”ì¸ ì‚¬ì´íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤\n" +
              "- ê²€ìƒ‰ ì¸ë±ìŠ¤ê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤\n" +
              "- ì‚¬ì´íŠ¸ë§µì´ ìƒˆë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤\n\n" +
              "ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰\n\n" +
              "---\n" +
              "*ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*";

            // PRì— ëŒ“ê¸€ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: deploymentComment
            });
            
            // ê´€ë ¨ ì´ìŠˆê°€ ìˆë‹¤ë©´ í•´ë‹¹ ì´ìŠˆì—ë„ ëŒ“ê¸€ ì¶”ê°€
            if (issueMatch) {
              const issueNumber = parseInt(issueMatch[1]);
              
              const issueComment = "## ğŸ‰ ì‚¬ì´íŠ¸ ë°˜ì˜ ì™„ë£Œ\n\n" +
                "ìš”ì²­í•˜ì‹  ìš©ì–´ê°€ ì„±ê³µì ìœ¼ë¡œ ë©”ì¸ ì‚¬ì´íŠ¸ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
                "### ğŸ”— í™•ì¸ ë§í¬\n" +
                "- **ë©”ì¸ ì‚¬ì´íŠ¸**: [https://glossary.kr](https://glossary.kr)\n" +
                `- **ê´€ë ¨ PR**: #${prNumber}\n\n` +
                "### ğŸ“‹ ì²˜ë¦¬ ì™„ë£Œ ì‚¬í•­\n" +
                "- âœ… ìš©ì–´ ê²€ì¦ í†µê³¼\n" +
                "- âœ… ê´€ë¦¬ì ìŠ¹ì¸ ì™„ë£Œ\n" +
                "- âœ… ìë™ PR ìƒì„± ë° ë³‘í•©\n" +
                "- âœ… ë©”ì¸ ì‚¬ì´íŠ¸ ë°°í¬ ì™„ë£Œ\n\n" +
                "ì´ìŠˆë¥¼ ë‹«ê² ìŠµë‹ˆë‹¤. ê¸°ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ¤\n\n" +
                "---\n" +
                "*ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*";
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: issueComment
                });
                
                // ì´ìŠˆ ë‹«ê¸°
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed',
                  labels: ['completed', 'deployed']
                });
              } catch (error) {
                console.log(`ì´ìŠˆ #${issueNumber} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error.message);
              }
            }