name: Auto PR Creation from Approved Issue

on:
  repository_dispatch:
    types: [create_pr_from_issue]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          npm ci
          pip install requests jsonschema pyyaml

      - name: Get issue details
        id: issue
        run: |
          python .github/scripts/get-issue-details.py \
            --issue-number="${{ github.event.client_payload.issue_number }}" \
            --github-token="${{ secrets.GITHUB_TOKEN }}"
        env:
          GITHUB_OUTPUT: ${{ runner.temp }}/github_output

      - name: Generate term data
        id: generate
        run: |
          python .github/scripts/generate-term-data.py \
            --issue-number="${{ github.event.client_payload.issue_number }}" \
            --issue-data="${{ steps.issue.outputs.issue-data }}" \
            --github-token="${{ secrets.GITHUB_TOKEN }}"

      - name: Create branch and commit changes
        id: branch
        run: |
          ISSUE_NUMBER="${{ github.event.client_payload.issue_number }}"
          BRANCH_NAME="issue-${ISSUE_NUMBER}-$(date +%s)"
          
          # ë¸Œëœì¹˜ ìƒì„±
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git add -A
          git commit -m "feat: ì´ìŠˆ #${ISSUE_NUMBER}ì—ì„œ ìë™ ìƒì„±ëœ ìš©ì–´ ì¶”ê°€

          - ìë™ ìƒì„±ëœ PRì…ë‹ˆë‹¤
          - ì›ë³¸ ì´ìŠˆ: #${ISSUE_NUMBER}
          - ê´€ë¦¬ì ìŠ¹ì¸ ì™„ë£Œ
          
          ğŸ¤– Generated with GitHub Actions"
          
          git push origin "$BRANCH_NAME"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ github.event.client_payload.issue_number }};
            const branchName = '${{ steps.branch.outputs.branch-name }}';
            
            // ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const issueTitle = issue.data.title;
            const issueAuthor = issue.data.user.login;
            
            // PR ìƒì„±
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[AUTO] ${issueTitle}`,
              head: branchName,
              base: 'master',
              body: `## ğŸ¤– ìë™ ìƒì„±ëœ PR

ì´ PRì€ ìŠ¹ì¸ëœ ì´ìŠˆì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

### ğŸ“‹ ì›ë³¸ ì´ìŠˆ
- **ì´ìŠˆ**: #${issueNumber}
- **ì œì¶œì**: @${issueAuthor}
- **ì œëª©**: ${issueTitle}

### ğŸ”„ ë³€ê²½ì‚¬í•­
- ìƒˆë¡œìš´ AI/ML ìš©ì–´ ì¶”ê°€
- JSON ë°ì´í„° íŒŒì¼ ì—…ë°ì´íŠ¸
- ê²€ìƒ‰ ì¸ë±ìŠ¤ ìë™ ì—…ë°ì´íŠ¸

### âœ… ê²€ì¦ ì™„ë£Œ í•­ëª©
- [x] ì´ìŠˆ í…œí”Œë¦¿ í•„ìˆ˜ í•„ë“œ ì™„ì„±
- [x] ë°ì´í„° í’ˆì§ˆ ê²€ì¦ í†µê³¼
- [x] ì¤‘ë³µ ìš©ì–´ ê²€ì‚¬ í†µê³¼
- [x] ê´€ë¦¬ì ìŠ¹ì¸ ì™„ë£Œ
- [x] JSON ìŠ¤í‚¤ë§ˆ ê²€ì¦ í†µê³¼
- [x] ìë™ ì •ë ¬ ë° í¬ë§·íŒ… ì ìš©

### ğŸ” ê²€í†  ìš”ì²­ì‚¬í•­
- [ ] ìµœì¢… ìš©ì–´ ê²€í† 
- [ ] ë²ˆì—­ í’ˆì§ˆ í™•ì¸
- [ ] ì‚¬ìš© ì˜ˆì‹œ ì ì ˆì„± ê²€í† 
- [ ] ì„ì‹œ ë¹Œë“œ ê²°ê³¼ í™•ì¸

### ğŸ“ ì¶”ê°€ ì •ë³´
ì›ë³¸ ì´ìŠˆ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ JSON ë°ì´í„°ê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
ë³€ê²½ì‚¬í•­ì€ ì„ì‹œ ë¯¸ë¦¬ë³´ê¸° ì‚¬ì´íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ê´€ë ¨ ì´ìŠˆ**: #${issueNumber}

---
ğŸ¤– **ìë™ ìƒì„±**: GitHub Actionsë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ìƒì„±ëœ PRì…ë‹ˆë‹¤.
`,
              draft: false
            });
            
            // PR ë²ˆí˜¸ ë°˜í™˜
            return pr.data.number;

      - name: Update issue with PR link
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ github.event.client_payload.issue_number }};
            const prNumber = ${{ steps.pr.outputs.result }};
            
            const comment = `## ğŸ”— ìë™ PR ìƒì„± ì™„ë£Œ

ìŠ¹ì¸ëœ ì´ìŠˆë¥¼ ë°”íƒ•ìœ¼ë¡œ PRì´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!

### ğŸ“‹ ìƒì„±ëœ PR
**PR**: #${prNumber}

### ğŸ”„ ë‹¤ìŒ ë‹¨ê³„  
1. **ì„ì‹œ ë¯¸ë¦¬ë³´ê¸°**: ê³§ ì„ì‹œ ë¹Œë“œê°€ ì™„ë£Œë˜ì–´ ë¯¸ë¦¬ë³´ê¸° ë§í¬ê°€ ì œê³µë©ë‹ˆë‹¤
2. **ìµœì¢… ê²€í† **: ê´€ë¦¬ìê°€ PRì„ ìµœì¢… ê²€í† í•©ë‹ˆë‹¤
3. **ë³‘í•©**: ê²€í†  ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ë³‘í•©ë˜ì–´ ì‚¬ì´íŠ¸ì— ë°˜ì˜ë©ë‹ˆë‹¤

### ğŸ“Š ì˜ˆìƒ ì™„ë£Œ ì‹œê°„
- ì„ì‹œ ë¹Œë“œ: 3-5ë¶„
- ìµœì¢… ê²€í† : 1-2ì¼  
- ì‚¬ì´íŠ¸ ë°˜ì˜: ë³‘í•© í›„ ì¦‰ì‹œ

ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰

---
*ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

      - name: Add labels to issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ github.event.client_payload.issue_number }};
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['pr-created']
            });

      - name: Add labels to PR
        uses: actions/github-script@v7  
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['auto-generated', 'term-addition']
            });