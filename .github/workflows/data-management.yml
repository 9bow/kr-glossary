name: Data Management Workflow

on:
  issues:
    types: [labeled, closed]
  issue_comment:
    types: [created]

jobs:
  # Issue ë¼ë²¨ì´ "approved"ë¡œ ë³€ê²½ë˜ë©´ ì‹¤í–‰
  process-approved-issue:
    if: >
      github.event.action == 'labeled' && 
      github.event.label.name == 'approved' &&
      (
        contains(github.event.issue.labels.*.name, 'type:term-addition') ||
        contains(github.event.issue.labels.*.name, 'type:term-modification') ||
        contains(github.event.issue.labels.*.name, 'type:contributor-addition') ||
        contains(github.event.issue.labels.*.name, 'type:organization-addition')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || pip install requests PyYAML jsonschema

      - name: Extract issue data
        id: extract
        run: |
          python .github/scripts/extract-issue-data.py \
            --issue-number ${{ github.event.issue.number }} \
            --issue-body '${{ github.event.issue.body }}' \
            --issue-title '${{ github.event.issue.title }}' \
            --labels '${{ join(github.event.issue.labels.*.name, ',') }}'

      - name: Create PR branch
        run: |
          BRANCH_NAME="auto-pr/${{ github.event.issue.number }}-$(date +%s)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b "$BRANCH_NAME"
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Process term addition/modification
        if: >
          contains(github.event.issue.labels.*.name, 'type:term-addition') ||
          contains(github.event.issue.labels.*.name, 'type:term-modification')
        run: |
          python .github/scripts/process-term-data.py \
            --issue-data-file issue_data.json \
            --action ${{ contains(github.event.issue.labels.*.name, 'type:term-addition') && 'add' || 'modify' }}

      - name: Process contributor addition
        if: contains(github.event.issue.labels.*.name, 'type:contributor-addition')
        run: |
          python .github/scripts/process-contributor-data.py \
            --issue-data-file issue_data.json

      - name: Process organization addition
        if: contains(github.event.issue.labels.*.name, 'type:organization-addition')
        run: |
          python .github/scripts/process-organization-data.py \
            --issue-data-file issue_data.json

      - name: Validate data integrity
        run: |
          python scripts/validate-terms.py
          python scripts/validate-sorting.py
          python scripts/check-duplicates.py

      - name: Commit changes
        run: |
          git add data/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            git commit -m "ğŸ¤– Auto-process issue #${{ github.event.issue.number }}

            - Type: ${{ join(github.event.issue.labels.*.name, ', ') }}
            - Issue: ${{ github.event.issue.title }}
            - Processed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            
            Co-authored-by: ${{ github.event.issue.user.login }} <${{ github.event.issue.user.id }}+${{ github.event.issue.user.login }}@users.noreply.github.com>"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Push branch and create PR
        if: env.HAS_CHANGES == 'true'
        run: |
          git push origin "$BRANCH_NAME"
          
          # PR ë³¸ë¬¸ ìƒì„±
          cat > pr_body.md << 'EOF'
          ## ğŸ¤– ìë™ ìƒì„±ëœ PR
          
          **ê´€ë ¨ Issue**: #${{ github.event.issue.number }}
          **ì²˜ë¦¬ ìœ í˜•**: ${{ join(github.event.issue.labels.*.name, ', ') }}
          
          ### ë³€ê²½ì‚¬í•­
          ì´ PRì€ ìŠ¹ì¸ëœ Issueë¥¼ ë°”íƒ•ìœ¼ë¡œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ### ê²€ì¦ ì™„ë£Œ
          - âœ… ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ í†µê³¼
          - âœ… ì •ë ¬ ìˆœì„œ í™•ì¸
          - âœ… ì¤‘ë³µ ë°ì´í„° ê²€ì‚¬ ì™„ë£Œ
          
          ### ìë™ ë³‘í•©
          ì´ PRì€ ëª¨ë“  ê²€ì¦ì´ í†µê³¼í•˜ë©´ ìë™ìœ¼ë¡œ ë³‘í•©ë©ë‹ˆë‹¤.
          
          ---
          *ğŸ¤– ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          EOF

          # PR ìƒì„±
          gh pr create \
            --title "ğŸ¤– Auto-process: ${{ github.event.issue.title }}" \
            --body-file pr_body.md \
            --head "$BRANCH_NAME" \
            --base main \
            --label "type:auto-generated" \
            --label "status:ready-to-merge"

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close original issue
        if: env.HAS_CHANGES == 'true'
        run: |
          gh issue close ${{ github.event.issue.number }} \
            --comment "âœ… ì´ IssueëŠ” ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ PRë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì€ ê³§ ìš©ì–´ì§‘ì— ë°˜ì˜ë©ë‹ˆë‹¤."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Auto-merge approved PRs
  auto-merge-pr:
    if: >
      github.event.action == 'labeled' && 
      github.event.label.name == 'status:ready-to-merge' &&
      contains(github.event.issue.labels.*.name, 'type:auto-generated')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Auto-merge PR
        run: |
          sleep 30  # GitHub API ë™ê¸°í™” ëŒ€ê¸°
          gh pr merge ${{ github.event.issue.number }} \
            --auto --squash \
            --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Cleanup rejected issues
  cleanup-rejected:
    if: >
      github.event.action == 'labeled' && 
      github.event.label.name == 'status:rejected'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Close rejected issue
        run: |
          gh issue close ${{ github.event.issue.number }} \
            --comment "âŒ ì´ IssueëŠ” ê²€í†  ê²°ê³¼ ë°˜ì˜ë˜ì§€ ì•Šê¸°ë¡œ ê²°ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ì‚¬ìœ ëŠ” ìœ„ì˜ ë¦¬ë·° ëŒ“ê¸€ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Monitor workflow status
  notify-status:
    if: >
      github.event.action == 'labeled' && 
      (
        github.event.label.name == 'approved' ||
        github.event.label.name == 'status:rejected' ||
        github.event.label.name == 'status:needs-review'
      )
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Notify status change
        run: |
          if [[ "${{ github.event.label.name }}" == "approved" ]]; then
            MESSAGE="ğŸ‰ ì´ ì œì•ˆì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ìë™ìœ¼ë¡œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..."
          elif [[ "${{ github.event.label.name }}" == "status:rejected" ]]; then
            MESSAGE="âŒ ì´ ì œì•ˆì€ ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          elif [[ "${{ github.event.label.name }}" == "status:needs-review" ]]; then
            MESSAGE="ğŸ‘€ ì¶”ê°€ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤. ê´€ë¦¬ìì˜ í”¼ë“œë°±ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."
          fi
          
          gh issue comment ${{ github.event.issue.number }} --body "$MESSAGE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}