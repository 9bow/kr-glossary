name: Preview Build for PR

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'data/terms/*.json'
      - 'data/contributors/*.json'
      - 'data/organizations/*.json'
      - 'src/**'
      - 'public/**'

permissions:
  contents: read
  pull-requests: write
  pages: write
  id-token: write

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-preview:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          npm ci
          pip install -r requirements.txt

      - name: Validate data files
        run: |
          python scripts/validate-terms.py
          python scripts/check-duplicates.py
          python scripts/validate-sorting.py
          python scripts/validate-index.py

      - name: Run tests
        run: npm run test:run

      - name: Type check
        run: npm run type-check

      - name: Lint code
        run: npm run lint

      - name: Build preview
        run: |
          npm run build:github
          echo "PREVIEW_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Create preview directory structure
        run: |
          mkdir -p preview/pr-${{ github.event.pull_request.number }}
          cp -r dist/* preview/pr-${{ github.event.pull_request.number }}/

      - name: Generate preview index
        run: |
          cat > preview/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Preview Builds - AI/ML ìš©ì–´ì§‘</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 40px; }
                  .preview-item { background: #f8f9fa; padding: 20px; margin: 10px 0; border-radius: 8px; }
                  .preview-link { color: #0969da; text-decoration: none; font-weight: 600; }
                  .preview-link:hover { text-decoration: underline; }
                  .pr-info { color: #656d76; font-size: 14px; margin-top: 8px; }
              </style>
          </head>
          <body>
              <h1>ğŸ” AI/ML ìš©ì–´ì§‘ ë¯¸ë¦¬ë³´ê¸° ë¹Œë“œ</h1>
              <p>Pull Requestë³„ ë¯¸ë¦¬ë³´ê¸° ì‚¬ì´íŠ¸ ëª©ë¡ì…ë‹ˆë‹¤.</p>
              
              <div class="preview-item">
                  <a href="pr-${{ github.event.pull_request.number }}/" class="preview-link">
                      PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
                  </a>
                  <div class="pr-info">
                      ì‘ì„±ì: @${{ github.event.pull_request.user.login }} | 
                      ìƒì„±: ${{ github.event.pull_request.created_at }} |
                      ë¹Œë“œ: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Upload preview artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: preview-${{ github.event.pull_request.number }}
          path: ./preview

      - name: Deploy preview to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          artifact_name: preview-${{ github.event.pull_request.number }}
        id: preview-deployment

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${prNumber}`;
            const shortSha = '${{ github.event.pull_request.head.sha }}'.substring(0, 7);
            
            // ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸° ëŒ“ê¸€ ì°¾ê¸°
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ” ë¯¸ë¦¬ë³´ê¸° ë¹Œë“œ')
            );
            
            const commentBody = "## ğŸ” ë¯¸ë¦¬ë³´ê¸° ë¹Œë“œ ì™„ë£Œ\n\n" +
              "ì„ì‹œ ë¯¸ë¦¬ë³´ê¸° ì‚¬ì´íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n" +
              "### ğŸŒ ë¯¸ë¦¬ë³´ê¸° ë§í¬\n" +
              `**ğŸš€ [ì„ì‹œ ì‚¬ì´íŠ¸ ë³´ê¸°](${previewUrl})**\n\n` +
              "### ğŸ“Š ë¹Œë“œ ì •ë³´\n" +
              `- **ì»¤ë°‹**: \`${shortSha}\`\n` +
              `- **ë¹Œë“œ ì‹œê°„**: ${new Date().toISOString().replace('T', ' ').substring(0, 19)} UTC\n` +
              "- **ìƒíƒœ**: âœ… ì„±ê³µ\n\n" +
              "### ğŸ” ê²€í†  í¬ì¸íŠ¸\n" +
              "- ìƒˆë¡œ ì¶”ê°€ëœ ìš©ì–´ê°€ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸\n" +
              "- ê²€ìƒ‰ ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸\n" +
              "- ê´€ë ¨ ìš©ì–´ ë§í¬ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n" +
              "- ë°˜ì‘í˜• ë””ìì¸ì´ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸\n\n" +
              "### âš ï¸ ì£¼ì˜ì‚¬í•­\n" +
              "- ì´ ë¯¸ë¦¬ë³´ê¸°ëŠ” ì„ì‹œìš©ì…ë‹ˆë‹¤\n" +
              "- PRì´ ë³‘í•©ë˜ë©´ ìë™ìœ¼ë¡œ ì œê±°ë©ë‹ˆë‹¤\n" +
              "- ì‹¤ì œ ë°°í¬ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n\n" +
              "---\n" +
              "*ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹Œë“œê°€ ì—…ë°ì´íŠ¸ë˜ë©´ ëŒ“ê¸€ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*";

            if (botComment) {
              // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // ìƒˆ ëŒ“ê¸€ ì‘ì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

      - name: Add preview label to PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['preview-available']
            });

  cleanup-old-previews:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
      - name: Cleanup closed PR preview
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            
            // PR ë‹«í˜ ëŒ“ê¸€ ì¶”ê°€
            const merged = ${{ github.event.pull_request.merged }};
            const action = merged ? 'ë³‘í•©' : 'ë‹«í˜';
            const result = merged ? 'âœ… ë³‘í•©ë¨' : 'âŒ ë‹«í˜';
            const message = merged ? 'ë³€ê²½ì‚¬í•­ì´ ë©”ì¸ ì‚¬ì´íŠ¸ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰' : 'ë¯¸ë¦¬ë³´ê¸° ì‚¬ì´íŠ¸ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
            
            const commentBody = "## ğŸ—‘ï¸ ë¯¸ë¦¬ë³´ê¸° ì •ë¦¬ ì™„ë£Œ\n\n" +
              `PRì´ ${action}ë˜ì–´ ì„ì‹œ ë¯¸ë¦¬ë³´ê¸° ì‚¬ì´íŠ¸ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
              "### ğŸ“Š ìµœì¢… ìƒíƒœ\n" +
              `- **ê²°ê³¼**: ${result}\n` +
              `- **ì •ë¦¬ ì‹œê°„**: ${new Date().toISOString().replace('T', ' ').substring(0, 19)} UTC\n\n` +
              `${message}\n\n` +
              "---\n" +
              "*ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

  build-status-check:
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Comment build failure
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            
            const commentBody = "## âŒ ë¯¸ë¦¬ë³´ê¸° ë¹Œë“œ ì‹¤íŒ¨\n\n" +
              "ì„ì‹œ ë¯¸ë¦¬ë³´ê¸° ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n" +
              "### ğŸ” í™•ì¸ ì‚¬í•­\n" +
              "- ë°ì´í„° íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”\n" +
              "- JSON ë¬¸ë²• ì˜¤ë¥˜ê°€ ì—†ëŠ”ì§€ ê²€í† í•´ì£¼ì„¸ìš”\n" +
              "- í•„ìˆ˜ í•„ë“œê°€ ëª¨ë‘ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”\n" +
              "- Lint ë° Type ê²€ì‚¬ë¥¼ í†µê³¼í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”\n\n" +
              "### ğŸ› ï¸ í•´ê²° ë°©ë²•\n" +
              "1. ë¡œì»¬ì—ì„œ `npm run validate` ì‹¤í–‰\n" +
              "2. ì˜¤ë¥˜ ë©”ì‹œì§€ í™•ì¸ ë° ìˆ˜ì •\n" +
              "3. ì½”ë“œ í‘¸ì‹œ í›„ ìë™ ì¬ë¹Œë“œ ëŒ€ê¸°\n\n" +
              "### ğŸ“‹ ë¹Œë“œ ë¡œê·¸\n" +
              "ìì„¸í•œ ì˜¤ë¥˜ ë‚´ìš©ì€ [Actions íƒ­](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n" +
              "---\n" +
              "*ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });